# Band Part Key App

バンドスコアPDFから特定のパート（ボーカル、キーボード等）を自動抽出するWebアプリケーション

## 🚀 主な機能

### 📄 PDFタイプ自動検出
- 画像ベース/テキストベースを自動判別
- 最適な抽出方法を自動選択

### 🎵 スマート抽出（デフォルト）
- **4小節固定**: 見やすく整理されたレイアウト
- **ボーカル統合**: コード・メロディ・歌詞を一体化
- **キーボード分離**: キーボード/ピアノパートを独立抽出

### 🤖 AI精度モード（オプトイン）
- **外部AIでレイアウト推定**: PDFを画像化→bbox推定→クロップ合成
- **プレビュー+オーバーレイ**: bboxを確認し、マージンを調整
- **低信頼度時は高速モードへフォールバック**（ユーザーに通知）
- **AI送信は明示選択時のみ**（デフォルトは高速モード）

### 🎹 シンプルな操作
1. PDFをアップロード
2. 自動で処理開始
3. 抽出されたPDFをダウンロード
4. AI精度モードを選ぶ場合はプレビューでbboxを確認してから抽出

### 📁 出力管理
- 出力先: `outputs/extracted_scores/`（プロジェクト内）
- ファイル名: `{元のファイル名}_final_smart_{タイムスタンプ}.pdf`
- 著作権保護のためGitから除外

## 🎯 クイックスタート

### 1. ローカルテスト（最も簡単）

```bash
# テストスクリプトを実行
python run_local_test.py

# 別のPDFでテスト
python run_local_test.py /path/to/your/score.pdf
```

### 2. Webアプリケーションとして起動

```bash
# 依存関係をインストール
pip install -r requirements.txt

# AI精度モードを使う場合は .env を用意
cat <<'ENV' > .env
AI_API_KEY=your_api_key_here
ENV

# アプリケーションを起動
python app.py

# ブラウザで開く
# http://localhost:5003
```

### 3. Dockerで起動

```bash
# イメージをビルド
docker build -t band-part-key-app .

# コンテナを起動
docker run -p 5003:5003 band-part-key-app
```

## 📖 使い方

1. **PDFアップロード**: バンドスコアのPDFファイルをドラッグ&ドロップまたは選択
2. **自動分析**: PDFタイプを自動判別し、最適な抽出方法を提案
3. **設定選択**:
   - 抽出モード: 高速モード（デフォルト）/ AI精度モード（オプトイン）
   - パート選択: ボーカル、コード、キーボードから選択
   - 小節数: 4小節または8小節
   - オプション: 歌詞表示、画像ベース抽出
4. **抽出実行**: 「Extract Parts」ボタンをクリック
5. **自動保存**: 処理完了後、デスクトップに保存

## 💻 システム要件

- Python 3.8以上
- 必要なライブラリ:
  - Flask
  - PyMuPDF (fitz)
  - OpenCV (opencv-python-headless)
  - NumPy
  - Pillow
  - pytesseract（OCR用、オプション）

## 📂 プロジェクト構造

```
band_part_key_app/
├── app.py                    # メインアプリケーション
├── run_local_test.py        # ローカルテストスクリプト 🆕
├── requirements.txt         # 依存関係
├── Dockerfile              # Docker設定
│
├── core/                   # コア機能
│   ├── fast_image_extractor.py      # 高速画像ベース抽出 🆕
│   ├── measure_based_extractor.py   # 小節ベース抽出
│   ├── pdf_type_detector.py         # PDF自動判別 🆕
│   ├── preset_extractor.py          # プリセット抽出
│   └── integrated_vocal_extractor.py # 統合ボーカル抽出
│
├── templates/              # HTMLテンプレート
│   └── index.html
│
├── static/                 # 静的ファイル
│   ├── css/
│   │   └── style.css
│   └── js/
│       └── app.js
│
└── utils/                  # ユーティリティ
    └── file_handler.py
```

## 🔧 技術的な特徴

### PDFタイプ自動判別
- テキストブロック数と画像数を分析
- 最適な抽出方法を自動選択
- 信頼度スコアを表示

### 高速画像処理
- OCRを使用しない高速抽出
- 一般的なバンドスコアレイアウトに対応
- 処理時間: 0.1秒以下

### AI精度モード
- PDFページを画像化し、AIにレイアウトbboxを推定させる
- `AI_API_KEY` が未設定の場合はAIモードが失敗し、高速抽出にフォールバック
- 低信頼度のbboxは自動的に高速抽出へ切り替え

## 🔐 AI精度モード設定

AI精度モードは **明示選択** 時のみ外部AIに画像を送信します。以下の環境変数で制御できます。

| 変数 | 役割 | デフォルト |
| --- | --- | --- |
| `AI_API_KEY` | 外部AI APIキー | 未設定 |
| `AI_BASE_URL` | APIエンドポイント | `https://api.openai.com/v1/responses` |
| `AI_MODEL` | 使用モデル | `gpt-4o-mini` |
| `AI_CONFIDENCE_THRESHOLD` | 信頼度しきい値 | `0.6` |
| `AI_IMAGE_DPI` | 画像化DPI | `200` |
| `AI_MAX_PAGES` | AI処理ページ上限 | `10` |
| `AI_REQUEST_TIMEOUT` | APIタイムアウト | `60` |

### 小節単位の抽出
- 4小節と8小節の2つのモード
- 小節を揃えて見やすく配置
- パートごとに最適なサイズで表示

## ❓ トラブルシューティング

### PDFが正しく抽出されない場合
1. PDFタイプを確認（画像ベース/テキストベース）
2. 画像ベースの場合は「画像ベース抽出」オプションを有効化
3. それでも問題がある場合は、異なる抽出モードを試す

### 処理が遅い場合
- 画像ベースPDFでOCRを使用すると時間がかかることがあります
- 高速処理が必要な場合は、画像ベース抽出（OCRなし）を使用

### 出力ファイルが見つからない場合
- デスクトップ（~/Desktop）を確認
- ファイル名: `{元のファイル名}_{小節数}m.pdf`

### コードが正しく認識されない場合
- コード記号は「Em, F, G7, A#」などの形式で書かれている必要があります
- 「Cho」はコーラス（Chorus）として認識されます

## 🚧 今後の改善予定

- [ ] 楽譜構造の自動認識精度向上
- [ ] コード記号のOCR精度向上
- [ ] プレビュー機能の実装
- [ ] ユーザーフィードバック機能
- [ ] より多くの楽譜フォーマットへの対応

## ⚖️ ライセンス

このプロジェクトはプライベート利用を目的としています。
楽譜の著作権に注意して使用してください。

## 👤 作成者

Yodai (@wadansyaku)

---

🎵 Happy Music Making! 🎹
